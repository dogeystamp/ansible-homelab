---
- name: "Remote II: post-VM setup"
  hosts: all
  tasks:
    - name: Setup firewall
      ansible.builtin.import_role:
        name: nftables
      tags: firewall

    - name: Basic configuration
      ansible.builtin.import_role:
        name: essential
      tags: essential

    - name: Deploy Caddy
      ansible.builtin.import_role:
        name: caddy
      when: "'ingress' in group_names"
      tags: caddy
      vars:
        caddy_data_path: "/var/lib/caddy_c"

    - name: Deploy DNS server
      ansible.builtin.import_role:
        name: dns
      when: "'ingress' in group_names"
      tags: dns
      vars:
        dns_listen_interfaces:
          - wg1
        dns_domains:
          - domain: "{{ domain_main }}"
            ip_addr: "{{ bastion_vpn_ip }}"

    - name: Configure resolv.conf
      ansible.builtin.import_role:
        name: resolv
      tags: resolv
      vars:
        resolv_fallback: "{{ dns_recurse_ips[0] }}"

    - name: Deploy HAProxy
      ansible.builtin.import_role:
        name: haproxy
      when: "'haproxy' in group_names"
      tags: haproxy

    - name: Deploy ddclient
      ansible.builtin.import_role:
        name: ddclient
      when: "'ingress' in group_names"
      tags: ddclient

    - name: Deploy Borg clients
      ansible.builtin.import_role:
        name: borg_client
      when: "'borg_client' in group_names"
      tags: borg_client
      vars:
        borg_remote_server: "{{ hostvars[groups['borg_server'][0]].ansible_host }}"

    - name: "Compile Borg client list"
      ansible.builtin.set_fact:
        borg_client_hosts: |
          {{
            borg_client_hosts | default([]) +
            groups['borg_client']
          }}
      when: "'borg_server' in group_names"
      tags: borg_server

    - name: "Compile Borg pubkey list"
      ansible.builtin.set_fact:
        borg_ssh_pubkeys: |
          {{
            borg_ssh_pubkeys | default({}) | combine(hostvars.localhost.borg_ssh_pubkeys)
          }}
      when: "'borg_server' in group_names"
      tags: borg_server

    - name: Deploy Borg server
      ansible.builtin.import_role:
        name: borg_server
      when: "'borg_server' in group_names"
      tags: borg_server
